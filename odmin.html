<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬´ë£¡ê³ ë“±í•™êµ ì‹œì„¤ ê´€ë¦¬ì í˜ì´ì§€</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 15px; background-color: #f8f9fa; font-family: 'Pretendard', sans-serif; }
        
        #login-section { max-width: 450px; margin: 80px auto; background: white; padding: 40px 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .security-warning { background-color: #fff3cd; border-left: 5px solid #dc3545; color: #856404; padding: 15px; border-radius: 5px; font-size: 0.85rem; text-align: left; line-height: 1.6; margin-bottom: 25px; }
        
        #admin-section { display: none; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin: 20px auto; max-width: 1200px; }
        .btn-sm { margin-right: 3px; }
        .pw-masked { font-family: monospace; letter-spacing: 2px; color: #6c757d; }
        .pw-revealed { font-family: monospace; letter-spacing: 1px; color: #dc3545; font-weight: bold; }
        .header-actions { display: flex; justify-content: flex-end; margin-bottom: 15px; gap: 8px; flex-wrap: wrap; }
    </style>
</head>
<body>

    <div id="login-section">
        <h2 class="fw-bold mb-3">ì‹œì„¤ ê´€ë¦¬ì ì‹œìŠ¤í…œ</h2>
        <div class="security-warning">
            <strong>[ë³´ì•ˆ ê²½ê³ ]</strong><br>
            ë³¸ ê´€ë¦¬ì í˜ì´ì§€ëŠ” ë¬´ë£¡ê³ ë“±í•™êµ ì „êµí•™ìƒíšŒ ì„ì› ë° êµì§ì› ì „ìš©ì…ë‹ˆë‹¤. í—ˆê°€ë˜ì§€ ì•Šì€ ì ‘ê·¼ì„ ì—„ê²©íˆ ê¸ˆí•˜ë©°, ë¹„ë°€ë²ˆí˜¸ë¥¼ ì ˆëŒ€ íƒ€ì¸ì—ê²Œ ê³µìœ í•˜ê±°ë‚˜ ë…¸ì¶œí•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
        </div>
        <div class="mb-4">
            <input type="password" id="login-pw" class="form-control form-control-lg text-center" placeholder="ë¹„ë°€ë²ˆí˜¸ ë˜ëŠ” ë³´ì•ˆì½”ë“œ ì…ë ¥">
        </div>
        <div class="d-flex gap-2 justify-content-center">
            <button class="btn btn-primary w-50 fw-bold" onclick="attemptLogin('admin')">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
            <button class="btn btn-dark w-50 fw-bold" onclick="attemptLogin('super')">ìš´ì˜ ì±…ì„ì ë¡œê·¸ì¸</button>
        </div>
    </div>

    <div id="admin-section">
        <div class="header-actions">
            <button id="specific-block-btn" class="btn btn-warning btn-sm fw-bold" style="display: none;" onclick="openBlockModal()">â° ë¶€ë¶„ ì°¨ë‹¨</button>
            <button id="block-btn" class="btn btn-danger btn-sm fw-bold" style="display: none;" onclick="toggleBookingBlock()">ğŸ›‘ ì˜ˆì•½ ì „ì²´ ë§‰ê¸°</button>
            <button id="super-admin-btn" class="btn btn-dark btn-sm fw-bold" style="display: none;" onclick="openSuperAdmin()">âš™ï¸ ìš´ì˜ ì±…ì„ì ì„¤ì •</button>
            <button class="btn btn-outline-secondary btn-sm fw-bold" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <h2 class="text-center mb-4 mt-2">ë¬´ë£¡ê³ ë“±í•™êµ ì‹œì„¤ ê´€ë¦¬ ë³´ë“œ</h2>
        
        <div class="table-responsive">
            <table class="table table-hover align-middle" style="min-width: 800px;">
                <thead class="table-dark text-center">
                    <tr>
                        <th>ì´ë¦„(í•™ë²ˆ)</th>
                        <th>ì „í™”ë²ˆí˜¸</th>
                        <th>ì‹œì„¤ëª…</th>
                        <th>ëª©ì </th>
                        <th>ì´ìš© ì‹œê°„</th>
                        <th>ì·¨ì†Œ ë¹„ë²ˆ</th>
                        <th>ìƒíƒœ</th>
                        <th>ê´€ë¦¬ (ìŠ¹ì¸/ê±°ì ˆ)</th>
                    </tr>
                </thead>
                <tbody id="reserve-list" class="text-center"></tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="blockModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title fw-bold text-dark">â° íŠ¹ì • ì‹œì„¤ ë° ì‹œê°„ ì°¨ë‹¨</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="small text-muted mb-3">ì„ íƒí•œ ì‹œì„¤ê³¼ ì‹œê°„ëŒ€ì— í•™ìƒë“¤ì´ ì˜ˆì•½í•  ìˆ˜ ì—†ë„ë¡ ê°•ì œë¡œ ë§‰ìŠµë‹ˆë‹¤.</p>
            <label class="form-label fw-bold">ì°¨ë‹¨í•  ì‹œì„¤</label>
            <select id="b_room" class="form-select mb-3">
                <option value="ë”í•˜ìš°ìŠ¤">ë”í•˜ìš°ìŠ¤</option>
                <option value="í’‹ì‚´ì¥">í’‹ì‚´ì¥</option>
                <option value="ì†ŒíšŒì˜ì‹¤">ì†ŒíšŒì˜ì‹¤</option>
            </select>
            <label class="form-label fw-bold">ë‚ ì§œ ì„ íƒ</label>
            <input type="date" id="b_date" class="form-control mb-3">
            <div class="row">
                <div class="col-6">
                    <label class="form-label fw-bold">ì°¨ë‹¨ ì‹œì‘</label>
                    <select id="b_start" class="form-select"></select>
                </div>
                <div class="col-6">
                    <label class="form-label fw-bold">ì°¨ë‹¨ ì¢…ë£Œ</label>
                    <select id="b_end" class="form-select"></select>
                </div>
            </div>
            <label class="form-label fw-bold mt-3">ì°¨ë‹¨ ì‚¬ìœ  (ì„ íƒ)</label>
            <input type="text" id="b_purpose" class="form-control" placeholder="ì˜ˆ: ë™ì•„ë¦¬ ì •ê¸°í–‰ì‚¬, ì²­ì†Œ ë“±">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-danger fw-bold" onclick="submitSpecificBlock()">ì°¨ë‹¨ ë“±ë¡</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://uuimbwgcboqcavrouxtv.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GR9xwY16SVWEbfc648iOUA_U9za_DaN';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentAdminPassword = ''; 
        let currentRole = ''; 
        let isBookingBlocked = false; 
        let blockModal;

        async function loadSettings() {
            const { data, error } = await _supabase.from('site_settings').select('admin_password, is_booking_blocked').eq('id', 1).single();
            if (data) { 
                currentAdminPassword = data.admin_password; 
                isBookingBlocked = data.is_booking_blocked === true;
                updateBlockButtonUI();
            } 
        }
        loadSettings(); 

        function updateBlockButtonUI() {
            const btn = document.getElementById('block-btn');
            if (!btn) return;
            if (isBookingBlocked) {
                btn.innerText = "ğŸŸ¢ ì˜ˆì•½ ì—´ê¸°";
                btn.classList.replace('btn-danger', 'btn-success');
            } else {
                btn.innerText = "ğŸ›‘ ì˜ˆì•½ ì „ì²´ ë§‰ê¸°";
                btn.classList.replace('btn-success', 'btn-danger');
            }
        }

        async function toggleBookingBlock() {
            const actionMsg = isBookingBlocked ? "ì˜ˆì•½ì„ ë‹¤ì‹œ 'í™œì„±í™”'í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "í•™ìƒë“¤ì˜ ì˜ˆì•½ì„ ì„ì‹œë¡œ 'ì „ì²´ ì°¨ë‹¨'í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì ‘ì† ì‹œ ì ê²€ ì¤‘ í™”ë©´ì´ ëœ¹ë‹ˆë‹¤)";
            if (!confirm(actionMsg)) return;

            const { error } = await _supabase.from('site_settings').update({ is_booking_blocked: !isBookingBlocked }).eq('id', 1);
            if (!error) {
                isBookingBlocked = !isBookingBlocked;
                updateBlockButtonUI();
                alert(isBookingBlocked ? "ì „ì²´ ì˜ˆì•½ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤." : "ì˜ˆì•½ì´ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤.");
            } else { alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message); }
        }

        function attemptLogin(role) {
            const inputPw = document.getElementById('login-pw').value;
            if (!inputPw) { alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            if (role === 'admin') {
                if (inputPw === currentAdminPassword) { loginSuccess('admin'); } 
                else { alert("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
            } else if (role === 'super') {
                if (inputPw === 'mrhsfmo!') { loginSuccess('super'); } 
                else { alert("ìš´ì˜ ì±…ì„ì ë³´ì•ˆì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
            }
        }

        function loginSuccess(role) {
            currentRole = role;
            document.getElementById('login-pw').value = ''; 
            
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-section').style.display = 'block';

            // ëª¨ë“  ê´€ë¦¬ìì—ê²Œ 'ë¶€ë¶„ ì°¨ë‹¨' ê¸°ëŠ¥ ì˜¤í”ˆ
            document.getElementById('specific-block-btn').style.display = 'inline-block';

            if (role === 'super') {
                document.getElementById('super-admin-btn').style.display = 'inline-block';
                document.getElementById('block-btn').style.display = 'inline-block'; 
            } else {
                document.getElementById('super-admin-btn').style.display = 'none';
                document.getElementById('block-btn').style.display = 'none';
            }
            load(); 
        }

        function logout() {
            currentRole = '';
            document.getElementById('admin-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
        }

        function formatTime(dateStr) {
            const d = new Date(dateStr);
            return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }

        function getStatusText(status) {
            if(status === 'pending') return 'ëŒ€ê¸° ì¤‘';
            if(status === 'approved') return 'ìŠ¹ì¸ë¨';
            if(status === 'standby') return 'ì·¨ì†Œ ëŒ€ê¸°';
            if(status === 'rejected') return 'ê±°ì ˆë¨';
            if(status === 'cancelled') return 'ë³¸ì¸ ì·¨ì†Œ';
            if(status === 'blocked') return 'ì‹œìŠ¤í…œ ì°¨ë‹¨'; // ì¶”ê°€ë¨
            return status;
        }

        async function load() {
            const { data } = await _supabase.from('reservations').select('*').order('start_time', { ascending: false });
            const list = document.getElementById('reserve-list');
            list.innerHTML = '';
            
            data.forEach(res => {
                const timeString = `${formatTime(res.start_time)} ~ ${formatTime(res.end_time)}`;
                let actionButtons = '-';
                
                // ìƒíƒœë³„ ê´€ë¦¬ ë²„íŠ¼ ë…¸ì¶œ ë¡œì§ ë³€ê²½
                if (res.status === 'blocked') {
                    actionButtons = `<button onclick="unblockSpecificTime('${res.id}')" class="btn btn-sm btn-secondary w-100">ì°¨ë‹¨ í•´ì œ</button>`;
                } else if (res.status === 'pending' || res.status === 'standby') {
                    actionButtons = `
                        <button onclick="updateStatus('${res.id}', 'approved')" class="btn btn-sm btn-success mb-1 w-100">ìŠ¹ì¸</button><br>
                        <button onclick="updateStatus('${res.id}', 'rejected')" class="btn btn-sm btn-danger w-100">ê±°ì ˆ</button>
                    `;
                }
                
                const pwCell = (res.status === 'blocked') ? '-' : `<span id="pw-text-${res.id}" class="pw-masked">****</span><button id="pw-btn-${res.id}" class="btn btn-sm btn-outline-secondary ms-2" onclick="viewUserPw('${res.id}', '${res.password}')">ë³´ê¸°</button>`;
                const priorityBadge = res.is_priority ? `<br><span class="badge bg-danger mt-1">â­ìš°ì„ ê¶Œ</span>` : '';

                // ì°¨ë‹¨ëœ ê±´ì´ë©´ ì´ë¦„ ëŒ€ì‹  'ê´€ë¦¬ì'ë¡œ í‘œì‹œ
                let studentInfo = `${res.student_name}<br>(${res.student_id})`;
                if (res.status === 'blocked') {
                    studentInfo = `<span class="text-danger fw-bold">ì˜ˆì•½ ì œí•œ</span>`;
                }

                const row = `<tr>
                    <td>${studentInfo}</td>
                    <td>${res.phone}</td>
                    <td class="fw-bold">${res.room_name}${priorityBadge}</td>
                    <td>${res.purpose || '-'}</td>
                    <td class="fw-bold" style="font-size:0.9rem;">${timeString}</td>
                    <td>${pwCell}</td>
                    <td><span class="${res.status === 'blocked' ? 'text-danger fw-bold' : ''}">${getStatusText(res.status)}</span></td>
                    <td>${actionButtons}</td>
                </tr>`;
                list.innerHTML += row;
            });
        }

        function viewUserPw(id, realPw) {
            const textSpan = document.getElementById(`pw-text-${id}`);
            textSpan.innerText = realPw || '(ì—†ìŒ)';
            textSpan.className = 'pw-revealed';
            document.getElementById(`pw-btn-${id}`).style.display = 'none'; 
        }

        async function updateStatus(id, newStatus) {
            const actionName = newStatus === 'approved' ? 'ìŠ¹ì¸' : 'ê±°ì ˆ';
            if (!confirm(`ì •ë§ ${actionName}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const { error } = await _supabase.from('reservations').update({ status: newStatus }).eq('id', id);
            if (!error) { alert(`âœ… ${actionName} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`); load(); } 
            else { alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message); }
        }

        // âœ¨ íŠ¹ì • ì‹œê°„ ì°¨ë‹¨ ë¡œì§ ì‹œì‘ âœ¨
        function openBlockModal() {
            const startSelect = document.getElementById('b_start');
            const endSelect = document.getElementById('b_end');
            
            if (startSelect.options.length === 0) {
                for (let i = 7; i <= 16; i++) {
                    let hour = i.toString().padStart(2, '0');
                    startSelect.add(new Option(`${hour}:00`, `${hour}:00`));
                    endSelect.add(new Option(`${hour}:00`, `${hour}:00`));
                    if (i !== 16) { 
                        startSelect.add(new Option(`${hour}:30`, `${hour}:30`));
                        endSelect.add(new Option(`${hour}:30`, `${hour}:30`));
                    }
                }
            }
            
            document.getElementById('b_date').value = '';
            document.getElementById('b_purpose').value = '';
            blockModal = new bootstrap.Modal(document.getElementById('blockModal'));
            blockModal.show();
        }

        async function submitSpecificBlock() {
            const room = document.getElementById('b_room').value;
            const useDate = document.getElementById('b_date').value;
            const startTime = document.getElementById('b_start').value;
            const endTime = document.getElementById('b_end').value;
            const purpose = document.getElementById('b_purpose').value || 'ê´€ë¦¬ì ê¶Œí•œ ì°¨ë‹¨';

            if (!useDate || !startTime || !endTime) { alert("ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

            const start = new Date(`${useDate}T${startTime}`);
            const end = new Date(`${useDate}T${endTime}`);

            if (start >= end) { alert("ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }

            const { error } = await _supabase.from('reservations').insert([{
                student_name: 'ê´€ë¦¬ì ì°¨ë‹¨', student_id: 9999, phone: '00000000000', purpose: purpose, password: 'admin',
                room_name: room, start_time: start.toISOString(), end_time: end.toISOString(),
                status: 'blocked', is_priority: false
            }]);

            if (!error) {
                alert("ì§€ì •í•œ ì‹œì„¤ê³¼ ì‹œê°„ì˜ ì˜ˆì•½ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.");
                blockModal.hide();
                load();
            } else { alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message); }
        }

        // âœ¨ ë¶€ë¶„ ì°¨ë‹¨ í•´ì œ í•¨ìˆ˜ âœ¨
        async function unblockSpecificTime(id) {
            if(!confirm("ì´ ì‹œê°„ì˜ ì°¨ë‹¨ì„ í•´ì œí•˜ì—¬ í•™ìƒë“¤ì´ ì˜ˆì•½í•  ìˆ˜ ìˆê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const { error } = await _supabase.from('reservations').delete().eq('id', id);
            if(!error) { alert("ì°¨ë‹¨ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤."); load(); } 
            else { alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message); }
        }

        async function openSuperAdmin() {
            const action = prompt(`[ìš´ì˜ ì±…ì„ì ì „ìš© ë©”ë‰´]\nì›í•˜ì‹œëŠ” ì‘ì—…ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.\n\n1. ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½\n2. ì˜ˆì•½ ëª…ë‹¨ ì „ì²´ ì´ˆê¸°í™” (ì˜êµ¬ ì‚­ì œ)`);
            if (action === '1') {
                const newPw = prompt(`í˜„ì¬ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸: ${currentAdminPassword}\n\nìƒˆë¡­ê²Œ ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`);
                if (newPw) {
                    const { error } = await _supabase.from('site_settings').update({ admin_password: newPw }).eq('id', 1);
                    if (!error) {
                        currentAdminPassword = newPw; 
                        alert(`ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ '${newPw}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¼ë°˜ ê´€ë¦¬ìë“¤ì—ê²Œ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•ˆë‚´í•´ ì£¼ì„¸ìš”.`);
                    }
                }
            } else if (action === '2') {
                const confirmReset = confirm("âš ï¸ 1ì°¨ ê²½ê³ : ê¸°ì¡´ì˜ ëª¨ë“  ì˜ˆì•½ ëª…ë‹¨ ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.\nì •ë§ ì „ì²´ ì´ˆê¸°í™”ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                if (confirmReset) {
                    const finalCheck = prompt("ì´ˆê¸°í™”ë¥¼ ì§„í–‰í•˜ë ¤ë©´ ì•„ë˜ ì¹¸ì— 'ì´ˆê¸°í™”ì§„í–‰' ì´ë¼ê³  ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    if (finalCheck === 'ì´ˆê¸°í™”ì§„í–‰') {
                        const { error } = await _supabase.from('reservations').delete().neq('id', 0);
                        if (!error) { alert("ì˜ˆì•½ ëª…ë‹¨ì´ ì™„ë²½í•˜ê²Œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); load(); } 
                        else { alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message); }
                    } else { alert("ì…ë ¥ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."); }
                }
            }
        }
    </script>
</body>
</html>
