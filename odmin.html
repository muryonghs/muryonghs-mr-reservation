<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬´ë£¡ê³  ì‹œì„¤ ê´€ë¦¬ì í˜ì´ì§€</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 15px; background-color: #f8f9fa; font-family: 'Pretendard', sans-serif; }
        
        #login-section { max-width: 450px; margin: 80px auto; background: white; padding: 40px 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .security-warning { background-color: #fff3cd; border-left: 5px solid #dc3545; color: #856404; padding: 15px; border-radius: 5px; font-size: 0.85rem; text-align: left; line-height: 1.6; margin-bottom: 25px; }
        
        #admin-section { display: none; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin: 20px auto; max-width: 1200px; }
        .btn-sm { margin-right: 3px; }
        .pw-masked { font-family: monospace; letter-spacing: 2px; color: #6c757d; }
        .pw-revealed { font-family: monospace; letter-spacing: 1px; color: #dc3545; font-weight: bold; }
        .header-actions { display: flex; justify-content: flex-end; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div id="login-section">
        <h2 class="fw-bold mb-3">ì‹œì„¤ ê´€ë¦¬ì ì‹œìŠ¤í…œ</h2>
        <div class="security-warning">
            <strong>[ë³´ì•ˆ ê²½ê³ ]</strong><br>
            ë³¸ ê´€ë¦¬ì í˜ì´ì§€ëŠ” ë¬´ë£¡ê³ ë“±í•™êµ ì „êµí•™ìƒíšŒ ì„ì› ë° êµì§ì› ì „ìš©ì…ë‹ˆë‹¤. í—ˆê°€ë˜ì§€ ì•Šì€ ì ‘ê·¼ì„ ì—„ê²©íˆ ê¸ˆí•˜ë©°, ë¹„ë°€ë²ˆí˜¸ë¥¼ ì ˆëŒ€ íƒ€ì¸ì—ê²Œ ê³µìœ í•˜ê±°ë‚˜ ë…¸ì¶œí•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
        </div>
        <div class="mb-4">
            <input type="password" id="login-pw" class="form-control form-control-lg text-center" placeholder="ë¹„ë°€ë²ˆí˜¸ ë˜ëŠ” ë³´ì•ˆì½”ë“œ ì…ë ¥">
        </div>
        <div class="d-flex gap-2 justify-content-center">
            <button class="btn btn-primary w-50 fw-bold" onclick="attemptLogin('admin')">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
            <button class="btn btn-dark w-50 fw-bold" onclick="attemptLogin('super')">ìš´ì˜ ì±…ì„ì ë¡œê·¸ì¸</button>
        </div>
    </div>

    <div id="admin-section">
        <div class="header-actions">
            <button id="super-admin-btn" class="btn btn-dark btn-sm fw-bold" style="display: none;" onclick="openSuperAdmin()">âš™ï¸ ìš´ì˜ ì±…ì„ì ì ‘ê·¼</button>
            <button class="btn btn-outline-secondary btn-sm ms-2 fw-bold" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <h2 class="text-center mb-4 mt-2">ğŸ“¢ ë¬´ë£¡ê³ ë“±í•™êµ ì‹œì„¤ ê´€ë¦¬ ë³´ë“œ</h2>
        
        <div class="table-responsive">
            <table class="table table-hover align-middle" style="min-width: 800px;">
                <thead class="table-dark text-center">
                    <tr>
                        <th>ì´ë¦„(í•™ë²ˆ)</th>
                        <th>ì „í™”ë²ˆí˜¸</th>
                        <th>ì‹œì„¤ëª…</th>
                        <th>ëª©ì </th>
                        <th>ì´ìš© ì‹œê°„</th>
                        <th>ì·¨ì†Œ ë¹„ë²ˆ</th>
                        <th>ìƒíƒœ</th>
                        <th>ê´€ë¦¬ (ìŠ¹ì¸/ê±°ì ˆ)</th>
                    </tr>
                </thead>
                <tbody id="reserve-list" class="text-center"></tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://uuimbwgcboqcavrouxtv.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GR9xwY16SVWEbfc648iOUA_U9za_DaN';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentAdminPassword = ''; 
        let currentRole = ''; 

        async function loadSettings() {
            const { data, error } = await _supabase.from('site_settings').select('admin_password').eq('id', 1).single();
            if (data) { currentAdminPassword = data.admin_password; } 
        }
        loadSettings(); 

        function attemptLogin(role) {
            const inputPw = document.getElementById('login-pw').value;
            if (!inputPw) { alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            if (role === 'admin') {
                if (inputPw === currentAdminPassword) { loginSuccess('admin'); } 
                else { alert("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
            } else if (role === 'super') {
                if (inputPw === 'mrhsfmo!') { loginSuccess('super'); } 
                else { alert("ìš´ì˜ ì±…ì„ì ë³´ì•ˆì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
            }
        }

        function loginSuccess(role) {
            currentRole = role;
            document.getElementById('login-pw').value = ''; 
            
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-section').style.display = 'block';

            if (role === 'super') {
                document.getElementById('super-admin-btn').style.display = 'inline-block';
            } else {
                document.getElementById('super-admin-btn').style.display = 'none';
            }

            load(); 
        }

        function logout() {
            currentRole = '';
            document.getElementById('admin-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
        }

        function formatTime(dateStr) {
            const d = new Date(dateStr);
            return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }

        function getStatusText(status) {
            if(status === 'pending') return 'ëŒ€ê¸° ì¤‘';
            if(status === 'approved') return 'ìŠ¹ì¸ë¨';
            if(status === 'standby') return 'ì·¨ì†Œ ëŒ€ê¸°';
            if(status === 'rejected') return 'ê±°ì ˆë¨';
            if(status === 'cancelled') return 'ë³¸ì¸ ì·¨ì†Œ';
            return status;
        }

        async function load() {
            // ê´€ë¦¬ì í˜ì´ì§€ì—ì„œë„ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            const { data } = await _supabase.from('reservations').select('*').order('start_time', { ascending: false });
            const list = document.getElementById('reserve-list');
            list.innerHTML = '';
            
            data.forEach(res => {
                const timeString = `${formatTime(res.start_time)} ~ ${formatTime(res.end_time)}`;
                
                let actionButtons = '-';
                if (res.status === 'pending' || res.status === 'standby') {
                    actionButtons = `
                        <button onclick="updateStatus('${res.id}', 'approved')" class="btn btn-sm btn-success mb-1 w-100">ìŠ¹ì¸</button><br>
                        <button onclick="updateStatus('${res.id}', 'rejected')" class="btn btn-sm btn-danger w-100">ê±°ì ˆ</button>
                    `;
                }

                const pwCell = `
                    <span id="pw-text-${res.id}" class="pw-masked">****</span>
                    <button id="pw-btn-${res.id}" class="btn btn-sm btn-outline-secondary ms-2" onclick="viewUserPw('${res.id}', '${res.password}')">ë³´ê¸°</button>
                `;

                // âœ¨ ìš°ì„ ê¶Œ ë±ƒì§€ ì¶”ê°€ âœ¨
                const priorityBadge = res.is_priority ? `<br><span class="badge bg-danger mt-1">ìš°ì„ ê¶Œ</span>` : '';

                const row = `<tr>
                    <td>${res.student_name}<br>(${res.student_id})</td>
                    <td>${res.phone}</td>
                    <td class="fw-bold">${res.room_name}${priorityBadge}</td>
                    <td>${res.purpose || '-'}</td>
                    <td class="fw-bold" style="font-size:0.9rem;">${timeString}</td>
                    <td>${pwCell}</td>
                    <td>${getStatusText(res.status)}</td>
                    <td>${actionButtons}</td>
                </tr>`;
                list.innerHTML += row;
            });
        }

        function viewUserPw(id, realPw) {
            const textSpan = document.getElementById(`pw-text-${id}`);
            textSpan.innerText = realPw || '(ì—†ìŒ)';
            textSpan.className = 'pw-revealed';
            document.getElementById(`pw-btn-${id}`).style.display = 'none'; 
        }

        async function updateStatus(id, newStatus) {
            const actionName = newStatus === 'approved' ? 'ìŠ¹ì¸' : 'ê±°ì ˆ';
            if (!confirm(`ì •ë§ ${actionName}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const { error } = await _supabase.from('reservations').update({ status: newStatus }).eq('id', id);
            if (!error) { 
                alert(`âœ… ${actionName} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`); 
                load(); 
            } else { 
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message); 
            }
        }

        async function openSuperAdmin() {
            const action = prompt(`[ìš´ì˜ ì±…ì„ì ì „ìš© ë©”ë‰´]\nì›í•˜ì‹œëŠ” ì‘ì—…ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.\n\n1. ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½\n2. ì˜ˆì•½ ëª…ë‹¨ ì „ì²´ ì´ˆê¸°í™” (ì˜êµ¬ ì‚­ì œ)`);
            
            if (action === '1') {
                const newPw = prompt(`í˜„ì¬ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸: ${currentAdminPassword}\n\nìƒˆë¡­ê²Œ ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`);
                if (newPw) {
                    const { error } = await _supabase.from('site_settings').update({ admin_password: newPw }).eq('id', 1);
                    if (!error) {
                        currentAdminPassword = newPw; 
                        alert(`âœ… ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ '${newPw}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¼ë°˜ ê´€ë¦¬ìë“¤ì—ê²Œ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•ˆë‚´í•´ ì£¼ì„¸ìš”.`);
                    }
                }
            } else if (action === '2') {
                const confirmReset = confirm("âš ï¸ 1ì°¨ ê²½ê³ : ê¸°ì¡´ì˜ ëª¨ë“  ì˜ˆì•½ ëª…ë‹¨ ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.\nì •ë§ ì „ì²´ ì´ˆê¸°í™”ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                if (confirmReset) {
                    const finalCheck = prompt("ì´ˆê¸°í™”ë¥¼ ì§„í–‰í•˜ë ¤ë©´ ì•„ë˜ ì¹¸ì— 'ì´ˆê¸°í™”ì§„í–‰' ì´ë¼ê³  ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    if (finalCheck === 'ì´ˆê¸°í™”ì§„í–‰') {
                        const { error } = await _supabase.from('reservations').delete().neq('id', 0);
                        if (!error) {
                            alert("ì˜ˆì•½ ëª…ë‹¨ì´ ì™„ë²½í•˜ê²Œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                            load();
                        } else { alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message); }
                    } else { alert("ì…ë ¥ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."); }
                }
            }
        }
    </script>
</body>
</html>
