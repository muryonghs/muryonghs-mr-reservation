<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë¬´ë£¡ê³ ë“±í•™êµ ì‹œì„¤ ê´€ë¦¬ì í˜ì´ì§€</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 40px; background-color: #f8f9fa; font-family: 'Pretendard', sans-serif; }
        .admin-box { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); position: relative; }
        .btn-sm { margin-right: 3px; }
        .pw-masked { font-family: monospace; letter-spacing: 2px; color: #6c757d; }
        .pw-revealed { font-family: monospace; letter-spacing: 1px; color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="admin-box container shadow-sm">
        <button class="btn btn-dark btn-sm position-absolute top-0 end-0 m-3" onclick="openSuperAdmin()">âš™ï¸ ìš´ì˜ ì±…ì„ì ì ‘ê·¼</button>

        <h2 class="text-center mb-4 mt-2">ğŸ“¢ ë¬´ë£¡ê³ ë“±í•™êµ ì‹œì„¤ ê´€ë¦¬ ëª¨ë“œ</h2>
        <table class="table table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ì´ë¦„(í•™ë²ˆ)</th>
                    <th>ì „í™”ë²ˆí˜¸</th>
                    <th>ì‹œì„¤ëª…</th>
                    <th>ëª©ì </th>
                    <th>ì´ìš© ì‹œê°„</th>
                    <th>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</th>
                    <th>ìƒíƒœ</th>
                    <th>ê´€ë¦¬ (ìŠ¹ì¸/ê±°ì ˆ)</th>
                </tr>
            </thead>
            <tbody id="reserve-list"></tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://uuimbwgcboqcavrouxtv.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GR9xwY16SVWEbfc648iOUA_U9za_DaN';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentAdminPassword = ''; 

        async function loadSettings() {
            const { data, error } = await _supabase.from('site_settings').select('admin_password').eq('id', 1).single();
            if (data) { currentAdminPassword = data.admin_password; } 
            else { alert("ì„¤ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }
        }

        function formatTime(dateStr) {
            const d = new Date(dateStr);
            return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }

        function getStatusText(status) {
            if(status === 'pending') return 'ëŒ€ê¸° ì¤‘';
            if(status === 'approved') return 'ìŠ¹ì¸ë¨';
            if(status === 'standby') return 'ì·¨ì†Œ ëŒ€ê¸°';
            if(status === 'rejected') return 'ê±°ì ˆë¨';
            if(status === 'cancelled') return 'ë³¸ì¸ ì·¨ì†Œ';
            return status;
        }

        async function load() {
            const { data } = await _supabase.from('reservations').select('*').order('start_time', { ascending: false });
            const list = document.getElementById('reserve-list');
            list.innerHTML = '';
            
            data.forEach(res => {
                const timeString = `${formatTime(res.start_time)} ~ ${formatTime(res.end_time)}`;
                
                let actionButtons = '-';
                if (res.status === 'pending' || res.status === 'standby') {
                    actionButtons = `
                        <button onclick="updateStatus('${res.id}', 'approved')" class="btn btn-sm btn-success">ìŠ¹ì¸</button>
                        <button onclick="updateStatus('${res.id}', 'rejected')" class="btn btn-sm btn-danger">ê±°ì ˆ</button>
                    `;
                }

                const pwCell = `
                    <span id="pw-text-${res.id}" class="pw-masked">****</span>
                    <button id="pw-btn-${res.id}" class="btn btn-sm btn-outline-secondary ms-2" onclick="viewUserPw('${res.id}', '${res.password}')">ë³´ê¸°</button>
                `;

                const row = `<tr>
                    <td>${res.student_name}(${res.student_id})</td>
                    <td>${res.phone}</td>
                    <td>${res.room_name}</td>
                    <td>${res.purpose || '-'}</td>
                    <td class="fw-bold">${timeString}</td>
                    <td>${pwCell}</td>
                    <td>${getStatusText(res.status)}</td>
                    <td>${actionButtons}</td>
                </tr>`;
                list.innerHTML += row;
            });
        }

        function verifyAdminAction() {
            const input = prompt("ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë ¤ë©´ 'ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸'ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (input === null) return false; 
            if (input === currentAdminPassword) return true; 
            
            alert("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            return false;
        }

        function viewUserPw(id, realPw) {
            if (verifyAdminAction()) {
                const textSpan = document.getElementById(`pw-text-${id}`);
                textSpan.innerText = realPw || '(ì—†ìŒ)';
                textSpan.className = 'pw-revealed';
                document.getElementById(`pw-btn-${id}`).style.display = 'none'; 
            }
        }

        async function updateStatus(id, newStatus) {
            const actionName = newStatus === 'approved' ? 'ìŠ¹ì¸' : 'ê±°ì ˆ';
            if (!verifyAdminAction()) return; 
            if (!confirm(`ì •ë§ ${actionName}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const { error } = await _supabase.from('reservations').update({ status: newStatus }).eq('id', id);
            if (!error) { alert(`âœ… ${actionName} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`); load(); } 
            else { alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message); }
        }

        // âœ¨ ìš´ì˜ ì±…ì„ì ë©”ë‰´ (ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ & ëª…ë‹¨ ì´ˆê¸°í™”) âœ¨
        async function openSuperAdmin() {
            const code = prompt("ìš´ì˜ ì±…ì„ì ë³´ì•ˆì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (code === null) return; 
            if (code !== 'mrhsfmo!') { alert("ë³´ì•ˆì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì ‘ê·¼ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); return; }

            const action = prompt(`[ìš´ì˜ ì±…ì„ì ì¸ì¦ ì„±ê³µ]\nì›í•˜ì‹œëŠ” ì‘ì—…ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.\n\n1. ì·¨ì†Œ/ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½\n2. ì˜ˆì•½ ëª…ë‹¨ ì „ì²´ ì´ˆê¸°í™” (ì‚­ì œ)`);
            
            if (action === '1') {
                const newPw = prompt(`í˜„ì¬ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸: ${currentAdminPassword}\nìƒˆë¡­ê²Œ ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`);
                if (newPw) {
                    const { error } = await _supabase.from('site_settings').update({ admin_password: newPw }).eq('id', 1);
                    if (!error) {
                        currentAdminPassword = newPw; 
                        alert(`âœ… ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ '${newPw}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    }
                }
            } else if (action === '2') {
                const confirmReset = confirm("âš ï¸ ê²½ê³ : ê¸°ì¡´ì˜ ëª¨ë“  ì˜ˆì•½ ëª…ë‹¨ ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.\nì •ë§ ì „ì²´ ì´ˆê¸°í™”ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                if (confirmReset) {
                    const finalCheck = prompt("ì´ˆê¸°í™”ë¥¼ ì§„í–‰í•˜ë ¤ë©´ ì°½ì— 'ì´ˆê¸°í™”ì§„í–‰' ì´ë¼ê³  ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    if (finalCheck === 'ì´ˆê¸°í™”ì§„í–‰') {
                        // DBì˜ ëª¨ë“  ì˜ˆì•½ ë°ì´í„° ì‚­ì œ (idê°€ 0ì´ ì•„ë‹Œ ëª¨ë“  ë°ì´í„° = ì „ë¶€ ì‚­ì œ)
                        const { error } = await _supabase.from('reservations').delete().neq('id', 0);
                        if (!error) {
                            alert("âœ… ì˜ˆì•½ ëª…ë‹¨ì´ ì™„ë²½í•˜ê²Œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                            load();
                        } else {
                            alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
                        }
                    } else {
                        alert("ì…ë ¥í•œ ë‹¨ì–´ê°€ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ì´ˆê¸°í™”ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                }
            } else if (action !== null) {
                alert("ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
        }

        loadSettings().then(() => { load(); });
    </script>
</body>
</html>
