<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬´ë£¡ê³ ë“±í•™êµ ì‹œì„¤ ì˜ˆì•½</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding: 20px; font-family: 'Pretendard', sans-serif; }
        .reservation-card { max-width: 500px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .header-title { color: #2c3e50; font-weight: bold; text-align: center; margin-bottom: 25px; }
        .form-label { font-weight: bold; margin-top: 10px; }
        .btn-primary { background-color: #004a99; border: none; padding: 12px; font-weight: bold; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="reservation-card">
        <h2 class="header-title">ğŸ« ë¬´ë£¡ê³  ì‹œì„¤ ì˜ˆì•½</h2>
        <p class="text-center text-muted small">í‰ì¼ 07:00 ~ 18:00 ì´ìš© ê°€ëŠ¥</p>
        
        <div class="mb-3">
            <label class="form-label">ì´ìš©ì ì´ë¦„</label>
            <input type="text" id="name" class="form-control" placeholder="ì„±í•¨ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>

        <div class="mb-3">
            <label class="form-label">í•™ë²ˆ (4ìë¦¬)</label>
            <input type="number" id="sid" class="form-control" placeholder="ì˜ˆ: 1201" oninput="if(this.value.length > 4) this.value = this.value.slice(0, 4);">
        </div>

        <div class="mb-3">
            <label class="form-label">ì „í™”ë²ˆí˜¸</label>
            <input type="tel" id="phone" class="form-control" placeholder="010-0000-0000">
        </div>

        <div class="mb-3">
            <label class="form-label">ì‹œì„¤ ì„ íƒ</label>
            <select id="room" class="form-select">
                <option value="ë”í•˜ìš°ìŠ¤">ë”í•˜ìš°ìŠ¤</option>
                <option value="í’‹ì‚´ì¥">í’‹ì‚´ì¥</option>
                <option value="ì†ŒíšŒì˜ì‹¤">ì†ŒíšŒì˜ì‹¤</option>
            </select>
        </div>

        <div class="row">
            <div class="col-6 mb-3">
                <label class="form-label">ì‹œì‘ ì‹œê°„</label>
                <input type="datetime-local" id="start" class="form-control">
            </div>
            <div class="col-6 mb-3">
                <label class="form-label">ì¢…ë£Œ ì‹œê°„</label>
                <input type="datetime-local" id="end" class="form-control">
            </div>
        </div>

        <button onclick="submitReservation()" class="btn btn-primary w-100 mt-3">ì˜ˆì•½ ì‹ ì²­í•˜ê¸°</button>
        <div class="text-center mt-3">
            <a href="status.html" class="text-secondary small" style="text-decoration: none;">ğŸ“… ì‹¤ì‹œê°„ ì˜ˆì•½ í˜„í™© í™•ì¸</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://uuimbwgcboqcavrouxtv.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GR9xwY16SVWEbfc648iOUA_U9za_DaN';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function submitReservation() {
            const name = document.getElementById('name').value;
            const sid = document.getElementById('sid').value;
            const phone = document.getElementById('phone').value;
            const room = document.getElementById('room').value;
            const start = new Date(document.getElementById('start').value);
            const end = new Date(document.getElementById('end').value);

            if (!name || sid.length !== 4 || !phone || isNaN(start) || isNaN(end)) {
                alert("ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”. (í•™ë²ˆ 4ìë¦¬ í•„ìˆ˜)");
                return;
            }

            // ì‹œê°„ ì œí•œ ë¡œì§ (í‰ì¼ 07:00 ~ 18:00)
            const startHour = start.getHours();
            const endHour = end.getHours();
            const day = start.getDay(); 

            if (day === 0 || day === 6) { alert("í‰ì¼ì—ë§Œ ì˜ˆì•½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
            if (startHour < 7 || endHour > 18 || (endHour === 18 && end.getMinutes() > 0)) {
                alert("ì´ìš© ê°€ëŠ¥ ì‹œê°„ì€ 07:00 ~ 18:00ì…ë‹ˆë‹¤."); return;
            }
            if (start >= end) { alert("ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }

            // ì¤‘ë³µ ì˜ˆì•½ ì²´í¬
            const { data: existing } = await _supabase
                .from('reservations')
                .select('*')
                .eq('room_name', room)
                .eq('status', 'approved')
                .filter('start_time', 'lt', end.toISOString())
                .filter('end_time', 'gt', start.toISOString());

            if (existing && existing.length > 0) { alert("ì´ë¯¸ í•´ë‹¹ ì‹œê°„ì— ì˜ˆì•½ì´ ì¡´ì¬í•©ë‹ˆë‹¤."); return; }

            const { error } = await _supabase.from('reservations').insert([{
                student_name: name, student_id: sid, phone: phone,
                room_name: room, start_time: start.toISOString(), end_time: end.toISOString()
            }]);

            if (error) alert("ì—ëŸ¬: " + error.message);
            else { alert("âœ… ë¬´ë£¡ê³  ì‹œì„¤ ì˜ˆì•½ ì‹ ì²­ ì™„ë£Œ!"); location.reload(); }
        }
    </script>
</body>
</html>