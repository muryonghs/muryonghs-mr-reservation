<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬´ë£¡ê³ ë“±í•™êµ ì‹œì„¤ ì˜ˆì•½</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding: 20px; font-family: 'Pretendard', sans-serif; }
        .reservation-card { max-width: 500px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .header-title { color: #2c3e50; font-weight: bold; text-align: center; margin-bottom: 25px; }
        .form-label { font-weight: bold; margin-top: 10px; }
        .btn-primary { background-color: #004a99; border: none; padding: 12px; font-weight: bold; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="reservation-card">
        <h2 class="header-title">ğŸ« ë¬´ë£¡ê³ ë“±í•™êµ ì‹œì„¤ ì˜ˆì•½</h2>
        <p class="text-center text-muted small">í‰ì¼ 07:00 ~ 18:00 ì´ìš© ê°€ëŠ¥</p>
        
        <div class="mb-3">
            <label class="form-label">ì´ìš©ì ì´ë¦„</label>
            <input type="text" id="name" class="form-control" placeholder="ì„±í•¨ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>

        <div class="mb-3">
            <label class="form-label">í•™ë²ˆ (4ìë¦¬)</label>
            <input type="number" id="sid" class="form-control" placeholder="ì˜ˆ: 1201" oninput="if(this.value.length > 4) this.value = this.value.slice(0, 4);">
        </div>

        <div class="mb-3">
            <label class="form-label">ì „í™”ë²ˆí˜¸</label>
            <input type="tel" id="phone" class="form-control" placeholder="010-0000-0000">
        </div>

        <div class="mb-3">
            <label class="form-label">ì´ìš© ëª©ì </label>
            <input type="text" id="purpose" class="form-control" placeholder="ì˜ˆ: ë™ì•„ë¦¬ íšŒì˜, ë©˜í† ë§, ììŠµ ë“±">
        </div>

        <div class="mb-3">
            <label class="form-label">ì‹œì„¤ ì„ íƒ</label>
            <select id="room" class="form-select">
                <option value="ë”í•˜ìš°ìŠ¤">ë”í•˜ìš°ìŠ¤</option>
                <option value="í’‹ì‚´ì¥">í’‹ì‚´ì¥</option>
                <option value="ì†ŒíšŒì˜ì‹¤">ì†ŒíšŒì˜ì‹¤</option>
            </select>
        </div>

        <div class="row">
            <div class="col-6 mb-3">
                <label class="form-label">ì‹œì‘ ì‹œê°„</label>
                <input type="datetime-local" id="start" class="form-control">
            </div>
            <div class="col-6 mb-3">
                <label class="form-label">ì¢…ë£Œ ì‹œê°„</label>
                <input type="datetime-local" id="end" class="form-control">
            </div>
        </div>

        <button onclick="openTermsModal()" class="btn btn-primary w-100 mt-3">ì˜ˆì•½ ì‹ ì²­í•˜ê¸°</button>
        <div class="text-center mt-3">
            <a href="status.html" class="text-secondary small" style="text-decoration: none;">ğŸ“… ì‹¤ì‹œê°„ ì˜ˆì•½ í˜„í™© í™•ì¸</a>
        </div>
    </div>

    <div class="modal fade" id="termsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold">ğŸ“ ì‹œì„¤ ì´ìš© ì•½ê´€ ë™ì˜</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ul class="text-muted small">
                <li>ë¬´ë£¡ê³ ë“±í•™êµ ì‹œì„¤ì€ ëª¨ë“  í•™ìƒì´ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ê³µê°„ì´ë¯€ë¡œ ê¹¨ë—í•˜ê²Œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.</li>
                <li>ê¸°ë¬¼ íŒŒì† ì‹œ ë°°ìƒì˜ ì±…ì„ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                <li>ì‚¬ì „ì— ì…ë ¥í•œ ì´ìš© ëª©ì ê³¼ ë‹¤ë¥´ê²Œ ì‚¬ìš©í•  ê²½ìš°, ì¦‰ì‹œ í‡´ì‹¤ ì¡°ì¹˜ ë° ì´í›„ ì˜ˆì•½ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                <li>ë’·ì •ë¦¬ ë° ì†Œë“±ì„ ì² ì €íˆ í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</li>
            </ul>
            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" id="agreeCheck">
              <label class="form-check-label fw-bold" for="agreeCheck">
                ìœ„ ì‹œì„¤ ì´ìš© ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-primary" onclick="submitReservation()">ìµœì¢… ì‹ ì²­</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://uuimbwgcboqcavrouxtv.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GR9xwY16SVWEbfc648iOUA_U9za_DaN';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let termsModal;

        // 1. ì •ë³´ ì…ë ¥ í™•ì¸ í›„ ëª¨ë‹¬ ì—´ê¸°
        function openTermsModal() {
            const name = document.getElementById('name').value;
            const sid = document.getElementById('sid').value;
            const phone = document.getElementById('phone').value;
            const purpose = document.getElementById('purpose').value;
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;

            if (!name || sid.length !== 4 || !phone || !purpose || !start || !end) {
                alert("ëª¨ë“  ì •ë³´(í•™ë²ˆ 4ìë¦¬ í¬í•¨)ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
                return;
            }
            // ì •ë³´ê°€ ë‹¤ ì…ë ¥ë˜ì—ˆìœ¼ë©´ ì•½ê´€ ì°½ ë„ìš°ê¸°
            termsModal = new bootstrap.Modal(document.getElementById('termsModal'));
            termsModal.show();
        }

        // 2. ìµœì¢… ì‹ ì²­ ì²˜ë¦¬
        async function submitReservation() {
            const agree = document.getElementById('agreeCheck').checked;
            if (!agree) {
                alert("ì•½ê´€ì— ë™ì˜í•˜ì…”ì•¼ ìµœì¢… ì‹ ì²­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }

            const name = document.getElementById('name').value;
            const sid = document.getElementById('sid').value;
            const phone = document.getElementById('phone').value;
            const purpose = document.getElementById('purpose').value;
            const start = new Date(document.getElementById('start').value);
            const end = new Date(document.getElementById('end').value);
            const room = document.getElementById('room').value;

            // ì‹œê°„ ì œí•œ ë¡œì§
            const startHour = start.getHours();
            const endHour = end.getHours();
            const day = start.getDay(); 

            if (day === 0 || day === 6) { alert("í‰ì¼ì—ë§Œ ì˜ˆì•½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
            if (startHour < 7 || endHour > 18 || (endHour === 18 && end.getMinutes() > 0)) {
                alert("ì´ìš© ê°€ëŠ¥ ì‹œê°„ì€ 07:00 ~ 18:00ì…ë‹ˆë‹¤."); return;
            }
            if (start >= end) { alert("ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }

            // ì¤‘ë³µ ì˜ˆì•½ ì²´í¬
            const { data: existing } = await _supabase
                .from('reservations')
                .select('*')
                .eq('room_name', room)
                .eq('status', 'approved')
                .filter('start_time', 'lt', end.toISOString())
                .filter('end_time', 'gt', start.toISOString());

            if (existing && existing.length > 0) { alert("ì´ë¯¸ í•´ë‹¹ ì‹œê°„ì— ìŠ¹ì¸ëœ ì˜ˆì•½ì´ ìˆìŠµë‹ˆë‹¤."); return; }

            // DB ì €ì¥ (purpose ì¶”ê°€)
            const { error } = await _supabase.from('reservations').insert([{
                student_name: name, student_id: sid, phone: phone, purpose: purpose,
                room_name: room, start_time: start.toISOString(), end_time: end.toISOString()
            }]);

            if (error) {
                alert("ì—ëŸ¬: " + error.message);
            } else {
                termsModal.hide(); // íŒì—… ë‹«ê¸°
                // ì™„ë£Œ ë©˜íŠ¸ ë³€ê²½
                alert("âœ… ì˜ˆì•½ ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤! ìµœì¢… ìŠ¹ì¸ì´ ë˜ì–´ì•¼ ì´ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."); 
                location.reload();
            }
        }
    </script>
</body>
</html>