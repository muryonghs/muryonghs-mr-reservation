<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬´ë£¡ê³ ë“±í•™êµ ì‹œì„¤ ì˜ˆì•½</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding: 20px; font-family: 'Pretendard', sans-serif; }
        .reservation-card { max-width: 500px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .header-title { color: #2c3e50; font-weight: bold; text-align: center; margin-bottom: 25px; }
        .form-label { font-weight: bold; margin-top: 10px; }
        .btn-primary { background-color: #004a99; border: none; padding: 12px; font-weight: bold; border-radius: 10px; }
        .notice-box { background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; text-align: center; font-size: 0.9rem; font-weight: bold; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="reservation-card">
        <h2 class="header-title">ë¬´ë£¡ê³ ë“±í•™êµ ì‹œì„¤ ì˜ˆì•½</h2>
        
        <div class="notice-box">
            ğŸ”” ì•ˆë‚´: ë‹¤ìŒ ì£¼(ì›”~ê¸ˆ) ì¼ì •ë§Œ ì˜ˆì•½ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
            (ì´ìš© ê°€ëŠ¥ ì‹œê°„: 07:00 ~ 18:00 / <strong>ìµœëŒ€ 2ì‹œê°„</strong>)
        </div>
        
        <div class="mb-3">
            <label class="form-label">ì´ìš©ì ì´ë¦„</label>
            <input type="text" id="name" class="form-control" placeholder="ì„±í•¨ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>

        <div class="mb-3">
            <label class="form-label">í•™ë²ˆ (4ìë¦¬)</label>
            <input type="number" id="sid" class="form-control" placeholder="ì˜ˆ: 1201" oninput="if(this.value.length > 4) this.value = this.value.slice(0, 4);">
        </div>

        <div class="mb-3">
            <label class="form-label">ì „í™”ë²ˆí˜¸ (- ì œì™¸ 11ìë¦¬)</label>
            <input type="tel" id="phone" class="form-control" placeholder="01012345678" maxlength="11" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
        </div>

        <div class="mb-3">
            <label class="form-label">ì´ìš© ëª©ì </label>
            <input type="text" id="purpose" class="form-control" placeholder="ì˜ˆ: ë™ì•„ë¦¬ íšŒì˜, ë©˜í† ë§, ììŠµ ë“±">
        </div>

        <div class="mb-3">
            <label class="form-label">ì‹œì„¤ ì„ íƒ</label>
            <select id="room" class="form-select">
                <option value="ë”í•˜ìš°ìŠ¤">ë”í•˜ìš°ìŠ¤</option>
                <option value="í’‹ì‚´ì¥">í’‹ì‚´ì¥</option>
                <option value="ì†ŒíšŒì˜ì‹¤">ì†ŒíšŒì˜ì‹¤</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">ì´ìš© ì¼ì (ë‹¤ìŒ ì£¼ ì›”~ê¸ˆ)</label>
            <select id="use_date" class="form-select"></select>
        </div>

        <div class="row">
            <div class="col-6 mb-3">
                <label class="form-label">ì‹œì‘ ì‹œê°„</label>
                <select id="start_time" class="form-select"></select>
            </div>
            <div class="col-6 mb-3">
                <label class="form-label">ì¢…ë£Œ ì‹œê°„</label>
                <select id="end_time" class="form-select"></select>
            </div>
        </div>

        <div class="mb-4 p-3 border rounded bg-light">
            <label class="form-label text-danger">ğŸ”’ ì˜ˆì•½ ì·¨ì†Œìš© ë¹„ë°€ë²ˆí˜¸ (í•„ìˆ˜)</label>
            <input type="password" id="password" class="form-control" placeholder="ì¶”í›„ ì˜ˆì•½ ì·¨ì†Œ ì‹œ ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
        </div>

        <button onclick="openTermsModal()" class="btn btn-primary w-100">ì˜ˆì•½ ì‹ ì²­í•˜ê¸°</button>
        <div class="text-center mt-3">
            <a href="status.html" class="text-secondary small" style="text-decoration: none;">ğŸ“… ì‹¤ì‹œê°„ ì˜ˆì•½ í˜„í™© ë° ì·¨ì†Œ</a>
        </div>
    </div>

    <div class="modal fade" id="termsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold">ì‹œì„¤ ì´ìš© ì•½ê´€ ë™ì˜</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ul class="text-muted small" style="padding-left: 20px;">
                <li class="mb-2">ë¬´ë£¡ê³ ë“±í•™êµ ì‹œì„¤ì€ ëª¨ë“  í•™ìƒì´ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ê³µê°„ì´ë¯€ë¡œ ê¹¨ë—í•˜ê²Œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.</li>
                <li class="mb-2">ì‚¬ì „ì— ì…ë ¥í•œ ì´ìš© ëª©ì ê³¼ ë‹¤ë¥´ê²Œ ì‚¬ìš©í•  ê²½ìš°, ì¦‰ì‹œ í‡´ì‹¤ ì¡°ì¹˜ ë° ì´í›„ ì˜ˆì•½ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                <li class="mb-2">ì˜ˆì•½ì€ ì¬í•™ìƒë§Œ ê°€ëŠ¥í•˜ë©°, ì‚¬ìš© ì‹œê°„ê³¼ í•™êµ ê·œì •ì„ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.</li>
                <li class="mb-2">ì‹œì„¤ ì‚¬ìš© í›„ ì •ë¦¬ì •ëˆ, ì“°ë ˆê¸° ì²˜ë¦¬, ëƒ‰Â·ë‚œë°© ë° ì „ë“± ì†Œë“± ë“± ì›ìƒë³µêµ¬ë¥¼ ì™„ë£Œí•´ì•¼ í•©ë‹ˆë‹¤.</li>
                <li class="mb-2">ê¸°ìì¬ ë° ì‹œì„¤ì„ í›¼ì†í•˜ê±°ë‚˜ ë¶„ì‹¤í•œ ê²½ìš° ë°°ìƒ ì±…ì„ì´ ìˆìŠµë‹ˆë‹¤.</li>
                <li class="mb-2">ë¬´ë‹¨ ë¯¸ì‚¬ìš©, í—ˆìœ„ ì˜ˆì•½, ê·œì • ìœ„ë°˜ ì‹œ ì¼ì • ê¸°ê°„ ì˜ˆì•½ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                <li class="mb-2">ì´ìš© ì¤‘ ë°œìƒí•œ ì•ˆì „ì‚¬ê³ ëŠ” í•™êµ ì§€ì¹¨ì— ë”°ë¼ ì²˜ë¦¬ë©ë‹ˆë‹¤.</li>
                <li class="mb-2">ì›í™œí•œ ìš´ì˜ì„ ìœ„í•´ ì´ë¦„, í•™ë²ˆ, ì—°ë½ì²˜ ë“±ì˜ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘Â·ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            </ul>
            <div class="form-check mt-3 border-top pt-3">
              <input class="form-check-input" type="checkbox" id="agreeCheck">
              <label class="form-check-label fw-bold text-primary" for="agreeCheck">
                ìœ„ ì‹œì„¤ ì´ìš© ì•½ê´€ì„ ëª¨ë‘ í™•ì¸í•˜ì˜€ìœ¼ë©°, ì´ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-primary" onclick="submitReservation()">ìµœì¢… ì‹ ì²­</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://uuimbwgcboqcavrouxtv.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GR9xwY16SVWEbfc648iOUA_U9za_DaN';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let termsModal;

        // âœ¨ ë‹¤ìŒ ì£¼ ì›”~ê¸ˆ ë‚ ì§œ 5ê°œë§Œ ê³„ì‚°í•´ì„œ ë“œë¡­ë‹¤ìš´(ëª©ë¡)ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” í•¨ìˆ˜ âœ¨
        function populateDateSelect() {
            const dateSelect = document.getElementById('use_date');
            dateSelect.innerHTML = ''; // ì´ˆê¸°í™”

            const now = new Date();
            const dayOfWeek = now.getDay();
            const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            
            const thisMonday = new Date(now);
            thisMonday.setDate(now.getDate() + diffToMonday);
            
            const nextMonday = new Date(thisMonday);
            nextMonday.setDate(thisMonday.getDate() + 7);

            const daysKo = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

            // ì›”(0)ë¶€í„° ê¸ˆ(4)ê¹Œì§€ 5ì¼ì¹˜ë§Œ ì˜µì…˜ìœ¼ë¡œ ì¶”ê°€
            for (let i = 0; i < 5; i++) {
                const targetDate = new Date(nextMonday);
                targetDate.setDate(nextMonday.getDate() + i);
                
                // ì‹¤ì œ ì €ì¥ë˜ëŠ” ê°’ (ì˜ˆ: 2024-10-21)
                const offset = targetDate.getTimezoneOffset() * 60000;
                const valueStr = (new Date(targetDate - offset)).toISOString().split('T')[0];
                
                // í™”ë©´ì— ë³´ì´ëŠ” ê¸€ì”¨ (ì˜ˆ: 10/21 (ì›”))
                const displayStr = `${targetDate.getMonth() + 1}/${targetDate.getDate()} (${daysKo[targetDate.getDay()]})`;
                
                dateSelect.add(new Option(displayStr, valueStr));
            }
        }

        function populateTimeSelects() {
            const startSelect = document.getElementById('start_time');
            const endSelect = document.getElementById('end_time');
            for (let i = 7; i <= 18; i++) {
                let hour = i.toString().padStart(2, '0');
                startSelect.add(new Option(`${hour}:00`, `${hour}:00`));
                endSelect.add(new Option(`${hour}:00`, `${hour}:00`));
                if (i !== 18) {
                    startSelect.add(new Option(`${hour}:30`, `${hour}:30`));
                    endSelect.add(new Option(`${hour}:30`, `${hour}:30`));
                }
            }
        }

        populateDateSelect();
        populateTimeSelects();

        function openTermsModal() {
            const name = document.getElementById('name').value;
            const sid = document.getElementById('sid').value;
            const phone = document.getElementById('phone').value;
            const purpose = document.getElementById('purpose').value;
            const password = document.getElementById('password').value;
            const useDate = document.getElementById('use_date').value;
            const startTime = document.getElementById('start_time').value;
            const endTime = document.getElementById('end_time').value;
            
            if (!name || sid.length !== 4 || !phone || !purpose || !password || !useDate) {
                alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ í¬í•¨í•œ ëª¨ë“  ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
                return;
            }

            if (phone.length !== 11) {
                alert("íœ´ëŒ€ì „í™” ë²ˆí˜¸ 11ìë¦¬ë¥¼ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”. (ì˜ˆ: 01012345678)");
                return;
            }

            const start = new Date(`${useDate}T${startTime}`);
            const end = new Date(`${useDate}T${endTime}`);

            if (start >= end) { alert("ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }

            const diffHours = (end.getTime() - start.getTime()) / (1000 * 60 * 60);
            if (diffHours > 2) {
                alert("1íšŒ ìµœëŒ€ ì´ìš© ê°€ëŠ¥ ì‹œê°„ì€ 2ì‹œê°„ì…ë‹ˆë‹¤.");
                return;
            }

            document.getElementById('agreeCheck').checked = false;
            termsModal = new bootstrap.Modal(document.getElementById('termsModal'));
            termsModal.show();
        }

        async function submitReservation() {
            const agree = document.getElementById('agreeCheck').checked;
            if (!agree) { alert("ì•½ê´€ì— ë™ì˜í•˜ì…”ì•¼ ìµœì¢… ì‹ ì²­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }

            const name = document.getElementById('name').value;
            const sid = document.getElementById('sid').value;
            const phone = document.getElementById('phone').value;
            const purpose = document.getElementById('purpose').value;
            const password = document.getElementById('password').value;
            const room = document.getElementById('room').value;
            
            const useDate = document.getElementById('use_date').value;
            const startTime = document.getElementById('start_time').value;
            const endTime = document.getElementById('end_time').value;
            
            const start = new Date(`${useDate}T${startTime}`);
            const end = new Date(`${useDate}T${endTime}`);

            const { data: existing } = await _supabase
                .from('reservations')
                .select('*')
                .eq('room_name', room)
                .in('status', ['approved', 'pending']) 
                .filter('start_time', 'lt', end.toISOString())
                .filter('end_time', 'gt', start.toISOString());

            let finalStatus = 'pending';

            if (existing && existing.length > 0) { 
                const wantStandby = confirm("ì´ë¯¸ ì˜ˆì•½ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤. ëŒ€ê¸° ì˜ˆì•½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ì˜ˆì•½ ì·¨ì†Œ ì‹œ ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì´ìš© ê°€ëŠ¥)");
                if (!wantStandby) {
                    termsModal.hide();
                    return; 
                }
                finalStatus = 'standby'; 
            }

            const { error } = await _supabase.from('reservations').insert([{
                student_name: name, student_id: sid, phone: phone, purpose: purpose, password: password,
                room_name: room, start_time: start.toISOString(), end_time: end.toISOString(),
                status: finalStatus 
            }]);

            if (error) {
                alert("ì—ëŸ¬: " + error.message);
            } else {
                termsModal.hide();
                if(finalStatus === 'standby') {
                    alert("ğŸ”„ ëŒ€ê¸° ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í˜„í™© í˜ì´ì§€ì—ì„œ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                } else {
                    alert("âœ… ì˜ˆì•½ ì‹ ì²­ ì™„ë£Œ! ìµœì¢… ìŠ¹ì¸ì´ ë˜ì–´ì•¼ ì´ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."); 
                }
                location.reload();
            }
        }
    </script>
</body>
</html>
