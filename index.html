<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬´ë£¡ê³ ë“±í•™êµ ì‹œì„¤ ì˜ˆì•½</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding: 20px; font-family: 'Pretendard', sans-serif; }
        .reservation-card { max-width: 500px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .header-title { color: #2c3e50; font-weight: bold; text-align: center; margin-bottom: 25px; }
        .form-label { font-weight: bold; margin-top: 10px; }
        .btn-primary { background-color: #004a99; border: none; padding: 12px; font-weight: bold; border-radius: 10px; }
        .notice-box { background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; text-align: center; font-size: 0.9rem; font-weight: bold; margin-bottom: 20px; }
        
        .terms-box {
            max-height: 350px; 
            overflow-y: auto; 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #dee2e6;
        }
    </style>
    <script>
        // âœ¨ ìˆ˜ì •ëœ ìš´ì˜ ì‚¬ì´í´: ì¼ìš”ì¼ ì˜¤í›„ 6ì‹œ ~ ì›”ìš”ì¼ ì˜¤í›„ 6ì‹œëŠ” í™•ì • ì‹œê°„(ì°¨ë‹¨) âœ¨
        function checkBookingWindow() {
            const now = new Date();
            const day = now.getDay(); // 0: ì¼ìš”ì¼, 1: ì›”ìš”ì¼
            const hour = now.getHours();

            // ì°¨ë‹¨ ì¡°ê±´: ì¼ìš”ì¼ 18ì‹œ(ì˜¤í›„ 6ì‹œ) ì´í›„ ~ ìì •  OR  ì›”ìš”ì¼ ìì • ~ 18ì‹œ(ì˜¤í›„ 6ì‹œ) ì´ì „
            const isSundayEvening = (day === 0 && hour >= 18);
            const isMondayBeforeEvening = (day === 1 && hour < 18);

            if (isSundayEvening || isMondayBeforeEvening) {
                document.addEventListener("DOMContentLoaded", function() {
                    document.body.innerHTML = `
                        <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:90vh; text-align:center;">
                            <div style="background:white; padding:40px; border-radius:20px; box-shadow:0 8px 20px rgba(0,0,0,0.1); max-width:400px; width:100%;">
                                <h1 style="font-size:3rem; margin-bottom:10px;">â›”ï¸</h1>
                                <h3 style="color:#2c3e50; font-weight:bold; margin-bottom:15px;">ì˜ˆì•½ í™•ì • ë° ì ê²€ ì‹œê°„</h3>
                                <p style="color:#6c757d; font-size:0.95rem; line-height:1.5;">
                                    í˜„ì¬ëŠ” ì ‘ìˆ˜ëœ ì˜ˆì•½ ëª…ë‹¨ì„ í™•ì •í•˜ëŠ” ì‹œê°„ì…ë‹ˆë‹¤.<br>ë‹¤ìŒ ì£¼ ì˜ˆì•½ì€ <strong>ì›”ìš”ì¼ ì˜¤í›„ 6ì‹œ</strong>ì— ì‹œì‘ë©ë‹ˆë‹¤.<br><br>
                                    ì˜¤í”ˆê¹Œì§€ ë‚¨ì€ ì‹œê°„
                                </p>
                                <div id="countdown" style="font-size: 2.8rem; font-weight: bold; color: #d63384; font-variant-numeric: tabular-nums; letter-spacing: 2px; margin-bottom: 20px;">
                                    00:00:00
                                </div>
                                <a href="status.html" class="btn btn-primary mt-3 w-100" style="padding:12px; border-radius:10px;">í˜„ì¬ ì˜ˆì•½ í˜„í™© ë³´ê¸°</a>
                            </div>
                        </div>
                    `;

                    function updateCountdown() {
                        const currentTime = new Date();
                        const targetTime = new Date();
                        
                        // ëª©í‘œ ì‹œê°„ì„ ì›”ìš”ì¼ ì˜¤í›„ 6ì‹œ(18ì‹œ)ë¡œ ì„¤ì •
                        if (currentTime.getDay() === 0) { // ì¼ìš”ì¼ ë°¤ì— ì ‘ì†í–ˆë‹¤ë©´ ë‚´ì¼(ì›”)ë¡œ ì„¸íŒ…
                            targetTime.setDate(currentTime.getDate() + 1);
                        }
                        targetTime.setHours(18, 0, 0, 0); // ì›”ìš”ì¼ 18ì‹œ ì •ê° (ì˜¤í›„ 6ì‹œ)

                        const diff = targetTime - currentTime;

                        // ì‹œê°„ì´ ë‹¤ ë˜ë©´ ì¦‰ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                        if (diff <= 0) {
                            location.reload();
                            return;
                        }

                        const hours = Math.floor(diff / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                        const h = String(hours).padStart(2, '0');
                        const m = String(minutes).padStart(2, '0');
                        const s = String(seconds).padStart(2, '0');

                        const countdownEl = document.getElementById("countdown");
                        if(countdownEl) countdownEl.innerText = `${h}:${m}:${s}`;
                    }

                    updateCountdown(); 
                    setInterval(updateCountdown, 1000);
                });
            }
        }
        checkBookingWindow();
    </script>
</head>
<body>
    <div class="reservation-card">
        <h2 class="header-title">ğŸ« ë¬´ë£¡ê³ ë“±í•™êµ ì‹œì„¤ ì˜ˆì•½</h2>
        
        <div class="notice-box">
            ğŸ”” ì•ˆë‚´: í˜„ì¬ [ë‹¤ìŒ ì£¼ ì›”~ê¸ˆ] ì¼ì • ì˜ˆì•½ ì§„í–‰ ì¤‘<br>
            (ì´ìš© ê°€ëŠ¥ ì‹œê°„: 07:00 ~ 18:00 / <strong>ìµœëŒ€ 2ì‹œê°„</strong>)
        </div>
        
        <div class="mb-3">
            <label class="form-label">ì´ìš©ì ì´ë¦„</label>
            <input type="text" id="name" class="form-control" placeholder="ì„±í•¨ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>

        <div class="mb-3">
            <label class="form-label">í•™ë²ˆ (4ìë¦¬)</label>
            <input type="number" id="sid" class="form-control" placeholder="ì˜ˆ: 1201" oninput="if(this.value.length > 4) this.value = this.value.slice(0, 4);">
        </div>

        <div class="mb-3">
            <label class="form-label">ì „í™”ë²ˆí˜¸ (- ì œì™¸ 11ìë¦¬)</label>
            <input type="tel" id="phone" class="form-control" placeholder="01012345678" maxlength="11" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
        </div>

        <div class="mb-3">
            <label class="form-label">ì´ìš© ëª©ì </label>
            <input type="text" id="purpose" class="form-control" placeholder="ì˜ˆ: ë™ì•„ë¦¬ íšŒì˜, ë©˜í† ë§, ììŠµ ë“±">
        </div>

        <div class="mb-3">
            <label class="form-label">ì‹œì„¤ ì„ íƒ</label>
            <select id="room" class="form-select">
                <option value="ë”í•˜ìš°ìŠ¤">ë”í•˜ìš°ìŠ¤</option>
                <option value="í’‹ì‚´ì¥">í’‹ì‚´ì¥</option>
                <option value="ì†ŒíšŒì˜ì‹¤">ì†ŒíšŒì˜ì‹¤</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">ì´ìš© ì¼ì (ë‹¤ìŒ ì£¼ ì›”~ê¸ˆ)</label>
            <select id="use_date" class="form-select"></select>
        </div>

        <div class="row">
            <div class="col-6 mb-3">
                <label class="form-label">ì‹œì‘ ì‹œê°„</label>
                <select id="start_time" class="form-select"></select>
            </div>
            <div class="col-6 mb-3">
                <label class="form-label">ì¢…ë£Œ ì‹œê°„</label>
                <select id="end_time" class="form-select"></select>
            </div>
        </div>

        <div class="mb-4 p-3 border rounded bg-light">
            <label class="form-label text-danger">ğŸ”’ ì˜ˆì•½ ì·¨ì†Œìš© ë¹„ë°€ë²ˆí˜¸ (í•„ìˆ˜)</label>
            <input type="password" id="password" class="form-control" placeholder="ì¶”í›„ ì˜ˆì•½ ì·¨ì†Œ ì‹œ ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
        </div>

        <button onclick="openTermsModal()" class="btn btn-primary w-100">ì˜ˆì•½ ì‹ ì²­í•˜ê¸°</button>
        <div class="text-center mt-3">
            <a href="status.html" class="text-secondary small" style="text-decoration: none;">ğŸ“… ì‹¤ì‹œê°„ ì˜ˆì•½ í˜„í™© ë° ì·¨ì†Œ</a>
        </div>
    </div>

    <div class="modal fade" id="termsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold">ë¬´ë£¡ê³ ë“±í•™êµ ì‹œì„¤ ì´ìš© ì•½ê´€</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="terms-box text-muted small">
                <ol style="padding-left: 15px; margin-bottom: 0; line-height: 1.6;">
                    <li class="mb-3">
                        <strong class="text-dark">ì´ìš© ëŒ€ìƒ</strong><br>
                        - ì˜ˆì•½ ë° ì‹œì„¤ ì´ìš©ì€ ì¬í•™ìƒì— í•œí•´ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                        - ì‹ ì²­í•œ ì‚¬ìš© ì‹œê°„ê³¼ í•™êµ ê·œì •ì„ ë°˜ë“œì‹œ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.
                    </li>
                    <li class="mb-3">
                        <strong class="text-dark">ì´ìš© ëª©ì  ì¤€ìˆ˜</strong><br>
                        - ì‚¬ì „ì— ì…ë ¥í•œ ì´ìš© ëª©ì ê³¼ ë‹¤ë¥´ê²Œ ì‚¬ìš©í•  ê²½ìš°, ì¦‰ì‹œ í‡´ì‹¤ ì¡°ì¹˜ ë° ì´í›„ ì˜ˆì•½ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </li>
                    <li class="mb-3">
                        <strong class="text-dark">ì‚¬ìš© í›„ ì •ë¦¬ ì˜ë¬´</strong><br>
                        - ì‹œì„¤ ì‚¬ìš© í›„ì—ëŠ” ì •ë¦¬ì •ëˆ, ì“°ë ˆê¸° ì²˜ë¦¬, ëƒ‰Â·ë‚œë°©ê¸° ë° ì „ë“± ì†Œë“±, ê¸°ìì¬ ì •ë¦¬ ë° í‚¤ ë°˜ë‚© ë“± <strong>ë°˜ë“œì‹œ ì›ìƒë³µêµ¬ë¥¼ ì™„ë£Œ</strong>í•´ì•¼ í•©ë‹ˆë‹¤.
                    </li>
                    <li class="mb-3">
                        <strong class="text-dark">ì‹œì„¤ ë° ê¸°ìì¬ ê´€ë¦¬</strong><br>
                        - ì‹œì„¤ì´ë‚˜ ê¸°ìì¬ë¥¼ í›¼ì† ë˜ëŠ” ë¶„ì‹¤í•œ ê²½ìš°, ë°°ìƒ ì±…ì„ì´ ìˆìŠµë‹ˆë‹¤.
                    </li>
                    <li class="mb-3">
                        <strong class="text-dark">ì˜ˆì•½ ê´€ë ¨ ìœ ì˜ì‚¬í•­</strong><br>
                        - ë¬´ë‹¨ ë¯¸ì‚¬ìš©, í—ˆìœ„ ì˜ˆì•½, ê·œì • ìœ„ë°˜ ì‹œ ì¼ì • ê¸°ê°„ ì˜ˆì•½ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </li>
                    <li class="mb-3">
                        <strong class="text-dark">ì•ˆì „ ë° ì±…ì„</strong><br>
                        - ì´ìš© ì¤‘ ì•ˆì „ì‚¬ê³ ì— ìœ ì˜í•´ì•¼ í•˜ë©°, ì•½ê´€ ìœ„ë°˜ ë˜ëŠ” ë¶€ì£¼ì˜ë¡œ ì¸í•œ ì‚¬ê³ ì˜ ì±…ì„ì€ ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.
                    </li>
                    <li class="mb-3">
                        <strong class="text-dark">ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©</strong><br>
                        - ì›í™œí•œ ìš´ì˜ì„ ìœ„í•´ ì´ë¦„, í•™ë²ˆ, ì—°ë½ì²˜ ë“±ì˜ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘Â·ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </li>
                    <li>
                        <strong class="text-dark">CCTV ìš´ì˜ ì•ˆë‚´</strong><br>
                        - ì‹œì„¤ ì•ˆì „ ë° ê´€ë¦¬ë¥¼ ìœ„í•´ CCTVê°€ ìƒì‹œ ë…¹í™” ì¤‘ì…ë‹ˆë‹¤.
                    </li>
                </ol>
            </div>
            <div class="form-check mt-3 pt-2">
              <input class="form-check-input" type="checkbox" id="agreeCheck">
              <label class="form-check-label fw-bold text-primary" for="agreeCheck">
                ìœ„ ì‹œì„¤ ì´ìš© ì•½ê´€ì„ ëª¨ë‘ í™•ì¸í•˜ì˜€ìœ¼ë©°, ì´ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-primary" onclick="submitReservation()">ìµœì¢… ì‹ ì²­</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://uuimbwgcboqcavrouxtv.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GR9xwY16SVWEbfc648iOUA_U9za_DaN';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let termsModal;

        // âœ¨ ì˜ˆì•½ ê°€ëŠ¥ ë‚ ì§œë¥¼ ë¬´ì¡°ê±´ 'ë‹¤ê°€ì˜¤ëŠ” ì›”ìš”ì¼~ê¸ˆìš”ì¼'ë¡œ ê°•ì œ ê³ ì • âœ¨
        function populateDateSelect() {
            const dateSelect = document.getElementById('use_date');
            if(!dateSelect) return; 
            dateSelect.innerHTML = ''; 

            const now = new Date();
            const dayOfWeek = now.getDay();
            
            // ë‹¤ê°€ì˜¤ëŠ” ì›”ìš”ì¼ ê³„ì‚°
            let daysToNextMonday;
            if (dayOfWeek === 0) {
                daysToNextMonday = 1; // ì˜¤ëŠ˜ì´ ì¼ìš”ì¼ì´ë©´ ë‚´ì¼ì´ ì›”ìš”ì¼
            } else {
                daysToNextMonday = 8 - dayOfWeek; // í‰ì¼ì´ë©´ ë‹¤ìŒ ì£¼ ì›”ìš”ì¼
            }

            const targetMonday = new Date(now);
            targetMonday.setDate(now.getDate() + daysToNextMonday);

            const daysKo = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

            for (let i = 0; i < 5; i++) {
                const targetDate = new Date(targetMonday);
                targetDate.setDate(targetMonday.getDate() + i);
                
                const offset = targetDate.getTimezoneOffset() * 60000;
                const valueStr = (new Date(targetDate - offset)).toISOString().split('T')[0];
                const displayStr = `${targetDate.getMonth() + 1}/${targetDate.getDate()} (${daysKo[targetDate.getDay()]})`;
                
                dateSelect.add(new Option(displayStr, valueStr));
            }
        }

        function populateTimeSelects() {
            const startSelect = document.getElementById('start_time');
            const endSelect = document.getElementById('end_time');
            if(!startSelect) return;

            for (let i = 7; i <= 18; i++) {
                let hour = i.toString().padStart(2, '0');
                startSelect.add(new Option(`${hour}:00`, `${hour}:00`));
                endSelect.add(new Option(`${hour}:00`, `${hour}:00`));
                if (i !== 18) {
                    startSelect.add(new Option(`${hour}:30`, `${hour}:30`));
                    endSelect.add(new Option(`${hour}:30`, `${hour}:30`));
                }
            }
        }

        populateDateSelect();
        populateTimeSelects();

        function openTermsModal() {
            const name = document.getElementById('name').value;
            const sid = document.getElementById('sid').value;
            const phone = document.getElementById('phone').value;
            const purpose = document.getElementById('purpose').value;
            const password = document.getElementById('password').value;
            const useDate = document.getElementById('use_date').value;
            const startTime = document.getElementById('start_time').value;
            const endTime = document.getElementById('end_time').value;
            
            if (!name || sid.length !== 4 || !phone || !purpose || !password || !useDate) {
                alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ í¬í•¨í•œ ëª¨ë“  ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
                return;
            }

            if (phone.length !== 11) {
                alert("íœ´ëŒ€ì „í™” ë²ˆí˜¸ 11ìë¦¬ë¥¼ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”. (ì˜ˆ: 01012345678)");
                return;
            }

            const start = new Date(`${useDate}T${startTime}`);
            const end = new Date(`${useDate}T${endTime}`);

            if (start >= end) { alert("ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }

            const diffHours = (end.getTime() - start.getTime()) / (1000 * 60 * 60);
            if (diffHours > 2) {
                alert("ğŸš« 1íšŒ ìµœëŒ€ ì´ìš© ê°€ëŠ¥ ì‹œê°„ì€ 2ì‹œê°„ì…ë‹ˆë‹¤.");
                return;
            }

            document.getElementById('agreeCheck').checked = false;
            termsModal = new bootstrap.Modal(document.getElementById('termsModal'));
            termsModal.show();
        }

        async function submitReservation() {
            const agree = document.getElementById('agreeCheck').checked;
            if (!agree) { alert("ì•½ê´€ì— ë™ì˜í•˜ì…”ì•¼ ìµœì¢… ì‹ ì²­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }

            const name = document.getElementById('name').value;
            const sid = document.getElementById('sid').value;
            const phone = document.getElementById('phone').value;
            const purpose = document.getElementById('purpose').value;
            const password = document.getElementById('password').value;
            const room = document.getElementById('room').value;
            
            const useDate = document.getElementById('use_date').value;
            const startTime = document.getElementById('start_time').value;
            const endTime = document.getElementById('end_time').value;
            
            const start = new Date(`${useDate}T${startTime}`);
            const end = new Date(`${useDate}T${endTime}`);

            const { data: existing } = await _supabase
                .from('reservations')
                .select('*')
                .eq('room_name', room)
                .in('status', ['approved', 'pending']) 
                .filter('start_time', 'lt', end.toISOString())
                .filter('end_time', 'gt', start.toISOString());

            let finalStatus = 'pending';

            if (existing && existing.length > 0) { 
                const wantStandby = confirm("ì´ë¯¸ ì˜ˆì•½ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤. ëŒ€ê¸° ì˜ˆì•½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ì˜ˆì•½ ì·¨ì†Œ ì‹œ ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì´ìš© ê°€ëŠ¥)");
                if (!wantStandby) {
                    termsModal.hide();
                    return; 
                }
                finalStatus = 'standby'; 
            }

            const { error } = await _supabase.from('reservations').insert([{
                student_name: name, student_id: sid, phone: phone, purpose: purpose, password: password,
                room_name: room, start_time: start.toISOString(), end_time: end.toISOString(),
                status: finalStatus 
            }]);

            if (error) {
                alert("ì—ëŸ¬: " + error.message);
            } else {
                termsModal.hide();
                if(finalStatus === 'standby') {
                    alert("ğŸ”„ ëŒ€ê¸° ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í˜„í™© í˜ì´ì§€ì—ì„œ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                } else {
                    alert("âœ… ì˜ˆì•½ ì‹ ì²­ ì™„ë£Œ! ìµœì¢… ìŠ¹ì¸ì´ ë˜ì–´ì•¼ ì´ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."); 
                }
                location.reload();
            }
        }
    </script>
</body>
</html>
